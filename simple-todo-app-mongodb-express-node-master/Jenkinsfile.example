// Example Jenkinsfile for Selenium Test Integration
// This is a reference file showing how to integrate Selenium tests into Jenkins pipeline

pipeline {
    agent any
    
    environment {
        NODE_VERSION = '18'
        APP_PORT = '5000'
        TEST_BASE_URL = "http://localhost:${APP_PORT}"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup') {
            steps {
                sh '''
                    node --version
                    npm --version
                    google-chrome --version
                    chromedriver --version
                '''
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'npm install'
            }
        }
        
        stage('Start MongoDB') {
            steps {
                sh '''
                    # Start MongoDB (adjust based on your setup)
                    sudo systemctl start mongod || true
                    # Or if using Docker:
                    # docker run -d -p 27017:27017 mongo:latest
                '''
            }
        }
        
        stage('Start Application') {
            steps {
                sh '''
                    # Start the application in background
                    nohup npm start > app.log 2>&1 &
                    echo $! > app.pid
                    
                    # Wait for application to be ready
                    timeout 60 bash -c 'until curl -f http://localhost:5000; do sleep 2; done' || true
                    sleep 5
                '''
            }
        }
        
        stage('Run Selenium Tests') {
            steps {
                sh '''
                    export TEST_BASE_URL=${TEST_BASE_URL}
                    npm run test:selenium
                '''
            }
            post {
                always {
                    // Archive test results if using JUnit reporter
                    // junit 'test-results.xml'
                    
                    // Archive screenshots if any failures
                    archiveArtifacts artifacts: 'screenshots/*', allowEmptyArchive: true
                }
            }
        }
        
        stage('Stop Application') {
            always {
                steps {
                    sh '''
                        # Stop the application
                        if [ -f app.pid ]; then
                            kill $(cat app.pid) || true
                            rm app.pid
                        fi
                        pkill -f "node app.js" || true
                    '''
                }
            }
        }
    }
    
    post {
        always {
            // Clean up
            sh 'rm -f app.log app.pid || true'
        }
        success {
            echo 'Pipeline succeeded!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}


